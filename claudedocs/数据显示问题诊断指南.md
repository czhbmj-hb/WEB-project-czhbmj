# 数据显示问题诊断和修复指南

## 🚨 问题症状

1. **后台管理页面刷新后**，产品分类和材料信息消失
2. **只有添加新的材料或分类时**才会显示已存在的
3. **产品不显示**：无论是后台还是前端都看不到产品

## 🔍 问题原因

这个问题的根本原因是 **Supabase RLS (Row Level Security) SELECT 权限缺失**。

### 什么是 RLS？

RLS 是 Supabase/PostgreSQL 的安全功能，用于控制谁可以访问哪些数据。如果缺少 SELECT 策略，即使数据存在于数据库中，前端也无法读取。

### 为什么会发生这个问题？

在之前的数据库更新脚本 `supabase_update_policies.sql` 中，只创建了 INSERT、UPDATE、DELETE 策略，**忘记创建 SELECT 策略**，导致匿名用户无法读取数据。

## ✅ 快速修复方案（推荐）

### 一键修复脚本

我已经为您准备了一个综合修复脚本 `COMPLETE_DATA_FIX.sql`，它会：
- ✅ 自动检查数据是否存在
- ✅ 删除所有旧的 SELECT 策略
- ✅ 创建正确的 SELECT 策略
- ✅ 设置必要的权限
- ✅ 补充缺失的默认数据
- ✅ 自动测试验证

### 执行步骤（5分钟）

1. **打开 Supabase Dashboard**
   - 登录您的 Supabase 项目

2. **打开 SQL Editor**
   - 点击左侧菜单 "SQL Editor"

3. **执行修复脚本**
   - 打开项目中的 `COMPLETE_DATA_FIX.sql` 文件
   - 复制所有内容
   - 粘贴到 SQL Editor
   - 点击 **Run** 执行

4. **查看执行结果**
   - 脚本会显示每一步的执行状态
   - 最后会显示数据统计和验证结果
   - 如果看到 "✅ 修复完成！" 表示成功

5. **清除浏览器缓存并测试**
   - 按 `Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac) 强制刷新
   - 检查产品、分类、材料是否正常显示

### 预期输出

执行成功后，您应该看到：

```
=== 数据统计 ===
table_name  | count
------------|------
Products    | 50+
Categories  | 7
Materials   | 8+

=== RLS 策略（应该包含 SELECT 策略） ===
tablename   | policyname                    | cmd
------------|-------------------------------|--------
categories  | Anyone can view categories    | SELECT
materials   | Anyone can view materials     | SELECT
products    | Anyone can view products      | SELECT

✅ 匿名用户访问测试通过！
✅ 修复完成！
```

## 诊断步骤

### 第一步：运行诊断脚本

1. 打开 Supabase Dashboard
2. 进入 **SQL Editor**
3. 打开项目中的 `DIAGNOSE_DATA_ISSUE.sql` 文件
4. 复制所有内容到 SQL Editor
5. 点击 **Run** 执行

**预期结果：**
- 应该看到产品、分类、材料的数量
- 应该看到 RLS 策略列表
- 应该看到 RLS 是否启用

**关键检查点：**

```sql
-- 如果这些查询返回 0 或空结果，说明数据丢失了
SELECT COUNT(*) FROM products;    -- 应该 > 0
SELECT COUNT(*) FROM categories;  -- 应该 > 0
SELECT COUNT(*) FROM materials;   -- 应该 > 0

-- 如果 RLS 策略不存在或配置错误，这里会显示出来
SELECT * FROM pg_policies WHERE tablename IN ('products', 'categories', 'materials');
```

### 第二步：分析诊断结果

#### 情况 A：数据存在，但没有 RLS 策略

**症状：**
```
Products Count: 50
Categories Count: 7
Materials Count: 8

但是 pg_policies 查询返回空或只有部分策略
```

**原因：** RLS 策略缺失或配置错误

**解决方案：** 运行 `FIX_RLS_PERMISSIONS.sql`

---

#### 情况 B：数据不存在

**症状：**
```
Products Count: 0
Categories Count: 0
Materials Count: 0
```

**原因：** 数据被意外删除或迁移失败

**解决方案：**
1. 检查是否运行了错误的 SQL 脚本
2. 需要重新导入产品数据
3. 需要重新创建分类和材料

---

#### 情况 C：RLS 启用但策略不正确

**症状：**
```
products      | rls_enabled: true
categories    | rls_enabled: true
materials     | rls_enabled: true

但是策略的 cmd 不包含 'SELECT' 或 roles 不包含 'anon'
```

**原因：** RLS 策略存在但权限不足

**解决方案：** 运行 `FIX_RLS_PERMISSIONS.sql`

## 修复步骤

### 修复 RLS 权限问题

如果诊断显示是 RLS 权限问题：

1. 打开 Supabase Dashboard → SQL Editor
2. 打开项目中的 `FIX_RLS_PERMISSIONS.sql` 文件
3. 复制所有内容到 SQL Editor
4. 点击 **Run** 执行

**这个脚本会：**
- 为 `products`、`categories`、`materials` 表创建正确的 SELECT 策略
- 允许匿名用户（anon）和认证用户（authenticated）读取数据
- 允许匿名用户提交询价单（enquiries）
- 显示最终的策略配置验证

**预期输出：**
```
tablename   | policyname                    | cmd    | roles
------------|-------------------------------|--------|-------
categories  | Anyone can view categories    | SELECT | public
materials   | Anyone can view materials     | SELECT | public
products    | Anyone can view products      | SELECT | public
enquiries   | Anyone can insert enquiries   | INSERT | public
```

### 验证修复

修复后，在 SQL Editor 中运行：

```sql
-- 模拟匿名用户查询（这是前端实际使用的方式）
SET ROLE anon;

SELECT COUNT(*) FROM products;
SELECT COUNT(*) FROM categories;
SELECT COUNT(*) FROM materials;

-- 恢复默认角色
RESET ROLE;
```

**如果修复成功：**
- 所有查询都应该返回正确的数量
- 不应该有权限错误

**如果仍然失败：**
- 检查是否有其他 RLS 策略冲突
- 检查表的所有者和权限设置

## 修复数据丢失问题

如果数据确实丢失了（诊断显示 COUNT = 0），需要：

### 1. 恢复分类数据

```sql
-- 插入默认分类
INSERT INTO categories (name, display_name, name_zh) VALUES
('screws', 'Screws', '螺丝'),
('bolts', 'Bolts', '螺栓'),
('nuts', 'Nuts', '螺母'),
('washers', 'Washers', '垫圈'),
('anchors', 'Anchors', '锚栓'),
('rivets', 'Rivets', '铆钉'),
('one-way-clutch', 'One-Way Clutch', '单向离合器')
ON CONFLICT (name) DO NOTHING;
```

### 2. 恢复材料数据

```sql
-- 插入默认材料
INSERT INTO materials (name, display_name, name_zh) VALUES
('stainless-steel', 'Stainless Steel', '不锈钢'),
('carbon-steel', 'Carbon Steel', '碳钢'),
('brass', 'Brass', '黄铜'),
('aluminum', 'Aluminum', '铝'),
('plastic', 'Plastic', '塑料'),
('nylon', 'Nylon', '尼龙'),
('titanium', 'Titanium', '钛'),
('copper', 'Copper', '铜')
ON CONFLICT (name) DO NOTHING;
```

### 3. 恢复产品数据

如果有备份：
- 使用 Excel 批量上传功能重新导入产品

如果没有备份：
- 需要手动重新添加产品
- 或者联系数据库管理员查看是否有自动备份

## 浏览器缓存问题

即使数据库修复了，浏览器可能还在使用旧的缓存数据。

**清除缓存步骤：**

### Chrome/Edge:
1. 按 `Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac) 强制刷新
2. 或者：F12 打开开发者工具 → Network 标签 → 勾选 "Disable cache" → 刷新页面

### 完全清除缓存:
1. 按 `Ctrl + Shift + Delete` (Windows) 或 `Cmd + Shift + Delete` (Mac)
2. 选择 "缓存的图像和文件"
3. 时间范围选择 "全部时间"
4. 点击 "清除数据"

## 前端控制台检查

打开浏览器开发者工具（F12），查看 Console 标签：

### 正常情况应该看到：
```
Multi-image manager initialized: success
```

### 如果有错误，可能看到：
```javascript
Error loading products: Error: ...
Error loading categories: Error: ...
Error loading materials: Error: ...
```

**这些错误信息会告诉我们具体问题是什么。**

## 网络请求检查

在浏览器开发者工具的 **Network** 标签中：

1. 刷新页面
2. 筛选 `supabase` 请求
3. 查看是否有失败的请求（红色）
4. 点击失败的请求，查看 **Response** 标签

**可能的错误：**
- `401 Unauthorized`: RLS 权限问题
- `404 Not Found`: 表不存在
- `500 Internal Server Error`: 数据库配置问题

## 完整测试流程

修复后，按照以下步骤测试：

### 1. 测试前端显示
- 打开网站首页
- 应该看到产品列表
- 应该看到左侧的分类筛选
- 应该看到材料筛选下拉框

### 2. 测试后台管理
- 登录后台管理
- 进入 "Categories & Materials" 标签
- 应该看到所有分类列表
- 应该看到所有材料列表
- 刷新页面，数据应该保持显示

### 3. 测试产品管理
- 点击 "Add New Product"
- 产品分类下拉框应该有选项
- 材料下拉框应该有选项
- 尝试添加一个测试产品
- 保存后应该在列表中显示

### 4. 测试多图片功能
- 编辑任意产品
- 上传多张图片
- 应该显示图片预览
- 保存后应该在前端显示

## 问题排查清单

- [ ] 运行诊断脚本 `DIAGNOSE_DATA_ISSUE.sql`
- [ ] 检查数据是否存在（COUNT > 0）
- [ ] 检查 RLS 策略是否正确
- [ ] 运行修复脚本 `FIX_RLS_PERMISSIONS.sql`
- [ ] 验证修复结果
- [ ] 清除浏览器缓存
- [ ] 强制刷新页面 (Ctrl+Shift+R)
- [ ] 检查浏览器控制台错误
- [ ] 检查网络请求状态
- [ ] 测试前端显示
- [ ] 测试后台管理
- [ ] 测试产品管理
- [ ] 测试多图片功能

## 需要反馈的信息

如果问题仍然存在，请提供：

1. **诊断脚本结果截图**（特别是数据数量和 RLS 策略部分）
2. **浏览器控制台错误截图**（F12 → Console 标签）
3. **网络请求错误截图**（F12 → Network 标签，显示失败的 supabase 请求）
4. **问题发生的具体步骤**

这些信息将帮助我们快速定位和解决问题。
